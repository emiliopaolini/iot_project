<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Hydroponic Agriculture</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" media	"all" href="./style.css" th:href="@{/style.css}" />
	
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
		crossorigin="anonymous"></script>
		
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
</head>

<body onload="setInterval(getNodes, 3000)" class="bg-light text-dark">
	<div class="p-3 mb-2 bg-light text-dark" id="mainDiv">
		<div class=" shadow-sm p-0 mb-5 bg-body rounded " style="margin: 1% 10% 1% 5%;">
			<h1 style="padding-left: 15%;">
				Hydroponic Agriculture Management
				<img src=" ./icon.png"></h1>
		</div>
		<div class="container">
			<div class="row ">
				<div class="col shadow-lg p-3 mb-5 bg-body rounded table-responsive">
					<table id="sensorsTable" class="table table-hover table-success  table-striped">
						<thead>
							<tr>
								<th scope="col">Sensor</th>
								<th scope="col">IP</th>
								<th scope="col">Assigned To</th>
								<th scope="col">Value</th>
								<th scope="col">Show Log</th>
								
							</tr>
						</thead>
						<tbody>
							
						</tbody>
					</table>
					
					
					
					<table class="table table-hover table-info  table-striped">
						<thead>
							<tr>
								<th scope="col">Actuator</th>
								<th scope="col">IP</th>
								<th scope="col">Active</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="node: ${actuators}">
								<td th:utext="${node.nodeResource}"> </td>
								<td th:utext="${node.nodeIP}"> </td>
								<td>
										<input class="form-check-input" type="checkbox"
											th:nodeIP="${node.nodeIP}"
											th:currentValue="${node.currentValue}"
											onclick="setActuator(this.getAttribute('nodeIP'), this.getAttribute('currentValue'))"
											name="status">
									</div>
								</td>
							</tr>

						</tbody>
					</table>
					
					
				
				
				
       				 	
				
				</div>
				<div class="col"><img src="./landing_image.jpg" style="width:90%; height:90%;"
						class="shadow-lg p-3 mb-5 bg-body rounded">
				</div>
			</div>
			
			
			<div class="row ">
					<div style="width: 100%; overflow-x: auto; overflow-y: hidden">
  <div style="width: 500px; height: 300px; ">
    <canvas id="canvas" height="300" width="0"></canvas>
  </div>
</div>
</div>

			
			
		</div>



		<script type="text/javascript" th:inline="javascript">			
			
			
			
			function getNodes() {
				//$('#mainDiv').load("/home");
				//$('#tables')
				console.log("i am here");
				$.ajax({
					type: 'GET',
					url: "/getSensors",
					success: function (data) {
						//now we have the nodes, we need to add them to the gui
						//console.log(data);
						var json_data = JSON.parse(data);
						
						
  						
  						for (var i = 0; i < json_data.jsonarray.length; i++){
						  var obj = json_data.jsonarray[i];
						  var nodeIP = obj["IP"];
						  var nodeResource = obj["Resource"];
						  var nodeType = obj["Type"];
						  var nodeValue = obj["Value"];
						  
						  if(nodeType=="sensor"){
						  		var newRow=document.getElementById('sensorsTable').insertRow();
						  		
						  		
  								newRow.innerHTML = "<td>"+nodeResource+"</td><td>"+nodeIP+"</td><td>ciao</td><td>"+nodeValue
  								+"</td><td> <input type=date id="+nodeIP+"> <input class=btn-dark type=button value=ShowLog onclick=getLog("+nodeIP+") name=status></td>";
  								
  						   }
						}
  						
  						
  						
  
					}
					
				});

			}
			
			function setActuator(ip, value) {
				$.ajax({
					type: 'GET',
					url: "/setActuator?nodeIP="+ip+"&&currentValue="+this.checked
				});


			}
		
			
			function getLog(ip){
				var date = document.getElementById(ip);
				if(date.value==""){
					//if the user doesn't choose any date, we set it to the current day
					var today = new Date();
					var dd = String(today.getDate()).padStart(2, '0');
					var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
					var yyyy = today.getFullYear();

					//date.value = yyyy+"-"+mm+"-"dd;
				}
				
				$.ajax({
		            type: 'GET',
		            url: '/getData?nodeIP='+ip+'&&date='+date.value,
		           	datatype: "JSON",
		            success: function (resulting_data) {
       				 	
       				 	console.log(resulting_data);
       				 	var data = JSON.parse(resulting_data);


       				 	var labels = data.jsonarray.map(function(e) {
						   return e.time.replace("_",":");
						});
						var values = data.jsonarray.map(function(e) {
						   return e.value;
						});;
       					
       					var ctx = document.getElementById('canvas').getContext('2d');
						var config = {
						options: {
					         legend: {
					            display: false
					         },
					    },
						   type: 'line',
						   data: {
						      labels: labels,
						      datasets: [{
						         label: '',
						         data: values,
						         backgroundColor: 'rgba(0, 0, 0, 0.5)'
						      }]
						   }
						};
						
						var chart = new Chart(ctx, config);
       					
       					
       					
    				}
		            
		        });
			}
			
			const checkboxes = document.querySelectorAll('input[name="status"]');
			checkboxes.forEach((checkbox) => {
				if (checkbox.getAttribute("currentValue") == "1")
					checkbox.checked = true;

			});

		</script>
	</div>
</body>

</html>