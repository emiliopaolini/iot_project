<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Hydroponic Agriculture</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<link rel="stylesheet" type="text/css" media	"all" href="./style.css" th:href="@{/style.css}" />
	
	<link rel="stylesheet" type="text/css" media href="./style.css" />
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
		crossorigin="anonymous"></script>

</head>

<body onLoad="setInterval(callUpdatePage, 3000)" class="bg-light text-dark">
	<div class="p-3 mb-2 bg-light text-dark" id="mainDiv">
		<div class=" shadow-sm p-0 mb-5 bg-body rounded " style="margin: 1% 10% 1% 5%;">
			<h1 style="padding-left: 15%;">
				Hydroponic Agriculture Management
				<img src=" ./icon.png"></h1>
		</div>
		<div class="container">
			<div class="row ">
				<div class="col shadow-lg p-3 mb-5 bg-body rounded table-responsive">
					<table class="table table-hover table-success  table-striped">
						<thead>
							<tr>
								<th scope="col">Sensor</th>
								<th scope="col">IP</th>
								<th scope="col">Assigned To</th>
								<th scope="col">Value</th>
								<th scope="col">Show Log</th>
								
							</tr>
						</thead>
						<tbody>
							<tr th:each="node: ${sensors}">
								<td th:utext="${node.nodeResource}"> </td>
								<td th:utext="${node.nodeIP}"> </td>
								<td th:utext="${node.actuator} ? ${node.actuator.nodeIP}: ''"> </td>
								<td th:utext="${node.currentValue}"> </td>
								<td>
								
									<input type="date" th:id="${node.nodeIP}">
									<input class="btn btn-dark" type="button"
											th:nodeIP="${node.nodeIP}"
											value="Show Log"
											onclick="getLog(this.getAttribute('nodeIP'))"
											name="status">		
								</td>
							</tr>
						</tbody>
					</table>
					
					
					
					<table class="table table-hover table-info  table-striped">
						<thead>
							<tr>
								<th scope="col">Actuator</th>
								<th scope="col">IP</th>
								<th scope="col">Active</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="node: ${actuators}">
								<td th:utext="${node.nodeResource}"> </td>
								<td th:utext="${node.nodeIP}"> </td>
								<td>
										<input class="form-check-input" type="checkbox"
											th:nodeIP="${node.nodeIP}"
											th:currentValue="${node.currentValue}"
											onclick="setActuator(this.getAttribute('nodeIP'), this.getAttribute('currentValue'))"
											name="status">
									</div>
								</td>
							</tr>

						</tbody>
					</table>
					
					
				
				<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.min.js"></script>
				<canvas id="canvas"></canvas>
       				 	
				
				</div>
				<div class="col"><img src="./landing_image.jpg" style="width:90%; height:90%;"
						class="shadow-lg p-3 mb-5 bg-body rounded">
				</div>
			</div>
		</div>




		<script type="text/javascript" th:inline="javascript">

			function callUpdatePage() {
				$('#mainDiv').load("/home");
				//$('#tables')
				//$.ajax({
				//	type: 'GET',
				//	url: "/home"
				//});

			}
			function setActuator(ip, value) {
				$.ajax({
					type: 'GET',
					url: "/setActuator?nodeIP="+ip+"&&currentValue="+this.checked
				});


			}
		
			
			function getLog(ip){
				
				var date = document.getElementById(ip);
				if(date.value==""){
					//if the user doesn't choose any date, we set it to the current day
					var today = new Date();
					var dd = String(today.getDate()).padStart(2, '0');
					var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
					var yyyy = today.getFullYear();

					//date.value = yyyy+"-"+mm+"-"dd;
				}
				
				$.ajax({
		            type: 'GET',
		            url: '/getData?nodeIP='+ip+'&&date='+date.value,
		            datatype: "JSON",
		            success: function (resulting_data) {
       				 	console.log(resulting_data);
       				 	var labels = resulting_data.jsonarray.map(function(e) {
   							return e.name;
						});
						var data = resulting_data.jsonarray.map(function(e) {
   							return e.age;
						});;
						
						var ctx = canvas.getContext('2d');
						var config = {
	   							type: 'line',
	   							data: {
		      						labels: labels,
		      						datasets: [{
		         						label: 'Graph Line',
		         						data: data,
		         						backgroundColor: 'rgba(0, 119, 204, 0.3)'
		      						}]
	   							}
						};

						var chart = new Chart(ctx, config);
       				 	
       				 	
    				}
		            
		        });
			}
			
			const checkboxes = document.querySelectorAll('input[name="status"]');
			checkboxes.forEach((checkbox) => {
				if (checkbox.getAttribute("currentValue") == "1")
					checkbox.checked = true;

			});

		</script>
	</div>
</body>

</html>